local script = script script.Name = "" getfenv().script = nil script.Parent = nil
local inventory = {}
local g
inventory.__index = inventory

function inventory.init(_g)
	g = _g
	local self = {}
	setmetatable(self, inventory)
	return self
end

function inventory:start()
	self.backpack = {}
	self.equipment = {}
	self.controllables = {}
	self.bankItems = {}
	self.statusFolder = g.player.Status
	self.tools = {}
	self.maxWeight = g.stats.arbs.defaultMaximumInventoryWeight
	self.weight = 0
	self.pounds = self.statusFolder.Pounds.Value
	self.bankPounds = self.statusFolder.BankPounds.Value
	self.full = false
	self.itemDrawn = nil
	self.lastDrawOrHolster = tick()
	self.warmthBonus = 0
	--self.cooldown = false
	--self.cooldown_time = 4

	self.statusFolder.Pounds.Changed:Connect(function()
		local pounds = self.statusFolder.Pounds.Value
		g.interface:updatePounds(pounds, self.pounds)
		self.pounds = pounds
		g.interface:refreshShopItems()
	end)

	self.statusFolder.BankPounds.Changed:Connect(function()
		self.bankPounds = self.statusFolder.BankPounds.Value
	end)

	self.statusFolder.Items.ChildAdded:Connect(function(child)
		local itemName = child.Name
		local item = g.item.new(itemName, nil, child)
		table.insert(self.backpack, item)
		if child.Value then
			item:equip(false)
		end
		g.interface:addItem(item)
		self:updateWeight()
		g.interface:refreshShopItems()
	end)

	self.statusFolder.Items.ChildRemoved:Connect(function(child)
		local item = self:getItemByObject(child)
		if item then
			if self.itemDrawn and item == self.itemDrawn then
				self.itemDrawn:unequip()
			end
			self:hideItem(item)
		end
	end)

	self.statusFolder.BankItems.ChildAdded:Connect(function(child)
		table.insert(self.bankItems, child.Name)
	end)

	self.statusFolder.BankItems.ChildRemoved:Connect(function(child)
		g.misc.remove(self.bankItems, child.Name)
	end)

	g.interface:updatePounds(self.pounds, self.pounds)
end

function inventory:hideItem(item)
	item:unequip()
	g.misc.remove(self.backpack, item)
	g.misc.remove(self.equipment, item)
	g.misc.remove(self.controllables, item)
	g.misc.remove(self.tools, item)
	self:updateWeight()
	g.interface:removeItem(item)
	g.interface:refreshShopItems()
end

function inventory:removeItem(item)
	self:hideItem(item)
	g.misc.request("remove", item.object)
end

function inventory:dropItem(item)
	self:hideItem(item)
	local position = g.interaction:getDropPosition(g.mouse.Hit.p)
	g.misc.request("drop", item.object, g.rootPart.Position:lerp(position, .4), position, unpack(item.content or {}))
end

function inventory:updateWeight()
	local weight = 0
	for i, v in pairs(self.backpack) do
		weight = weight + v.stats.weight
	end
	self.weight = weight
	self.full = self.weight > self.maxWeight
	if self.full then
		g.interface:newHint("You are over-encumbered")
	end
	g.stance:updateWalkSpeed()
end

function inventory:equipItem(item)
	local oldItem = self:getEquippedTypeItem(item.stats.type)
	if oldItem then
		oldItem:unequip()
	end

	g.misc.remove(self.backpack, item)
	table.insert(self.equipment, item)
	if item.stats.controls then
		table.insert(self.controllables, item)
		if not item.stats.canBeDrawn then
			g.interface:showItemControls(item)
		end
	end
	if item.stats.warmthBonus then
		self.warmthBonus = self.warmthBonus + item.stats.warmthBonus
	elseif item.stats.weightBonus then
		self.maxWeight = self.maxWeight + item.stats.weightBonus
	end
	self:updateWeight()
	g.interface:equipItem(item)
	self:updateToolItems()
end

function inventory:unequipItem(item)
	g.misc.remove(self.equipment, item)
	g.misc.remove(self.controllables, item)
	table.insert(self.backpack, item)
	if item.stats.warmthBonus then
		self.warmthBonus = self.warmthBonus - item.stats.warmthBonus
	elseif item.stats.weightBonus then
		self.maxWeight = self.maxWeight - item.stats.weightBonus
	end
	self:updateWeight()
	g.interface:unequipItem(item)
	g.interface:hideItemControls(item)
	self:updateToolItems()
end

function inventory:updateToolItems()
	self.tools = {}
	for i, v in pairs(self.equipment) do
		if v.stats.canBeDrawn then
			table.insert(self.tools, v)
			local toolSlot = g.misc.find(self.tools, v)
			if v.stats.preferedToolSlot and toolSlot ~= v.stats.preferedToolSlot then
				local otherItem = self.tools[v.stats.preferedToolSlot]
				self.tools[toolSlot] = otherItem
				self.tools[v.stats.preferedToolSlot] = v
			end
		end
	end
	g.interface:updateToolItems()
end

function inventory:getItemByObject(object)
	local item
	for i, v in pairs(self.backpack) do
		if v.object == object then
			return v
		end
	end
	for i, v in pairs(self.equipment) do
		if v.object == object then
			return v
		end
	end
end

function inventory:hasItemWithAmount(itemNameOrType, amount)
	local _amount = 0
	for i, v in pairs(self.backpack) do
		if v.name == itemNameOrType or v.stats.type == itemNameOrType then
			_amount = _amount + 1
		end
	end
	return _amount >= amount
end

function inventory:getBackpackNameItem(itemName)
	for i, v in pairs(self.backpack) do
		if v.name == itemName then
			return v
		end
	end
end

function inventory:getBackpackAmountNameItem(itemName)
	local amount = 0
	for i, v in pairs(self.backpack) do
		if v.name == itemName then
			amount = amount + 1
		end
	end
	return amount
end

function inventory:getBackpackTypeItem(itemType)
	for i, v in pairs(self.backpack) do
		if v.stats.type == itemType then
			return v
		end
	end
end

function inventory:getBackpackAmountTypeItem(itemType)
	local amount = 0
	for i, v in pairs(self.backpack) do
		if v.stats.type == itemType then
			amount = amount + 1
		end
	end
	return amount
end

function inventory:getEquippedNameItem(itemName)
	for i, v in pairs(self.equipment) do
		if v.name == itemName then
			return v
		end
	end
end

function inventory:getEquippedTypeItem(itemType)
	for i, v in pairs(self.equipment) do
		if v.stats.type == itemType then
			return v
		end
	end
end

function inventory:craftItem(itemName, craftingStation)
	if g.misc.request("craft", itemName,craftingStation) then
		local itemStats = g.stats.items[itemName]
		if itemStats.type == "consumable" and itemStats.consumableType == "food" then
			g.interface:newHint("You cook and store x" .. (itemStats.craftAmount or 1) .. " " .. itemName .. "(s) in your backpack")
		else
			g.interface:newHint("You craft and store x" .. (itemStats.craftAmount or 1) .. " " .. itemName .. "(s) in your backpack")
		end
		g.interface:refreshCraftableItems(craftingStation)
		g.stance:craft()
	end
end

function inventory:deployItem(item, cFrame) 
	spawn(function()
		if g.misc.request("deploy", item.object, cFrame) then 
			g.interface:newHint("You place down the " .. item.name)
			if item.stats.canOnlyBeDeployedOnIslands then
				g.interface:newHint("This can only be deployed on islands")
			else
				g.interface:newHint("You have already placed down this item")
			end
		end
	end)
end

function inventory:drawOrHolsterItem(item)
	if g.stance:canDoAction() and tick() - self.lastDrawOrHolster > g.stats.arbs.drawOrHolsterDebounceTime and not item.firing and not item.checkingAmmo and not item.reloading then
		self.lastDrawOrHolster = tick()


		if self.itemDrawn and self.itemDrawn == item then
			self:holsterItem()
		else
			self:drawItem(item)
		end
		g.interaction:reset()
	end
end

function inventory:drawItem(item)
	g.stance:endStances()
	item:draw()
	self.itemDrawn = item
	g.stance:updateWalkSpeed()
	g.interface:showItemControls(item)
end

function inventory:holsterItem()	
	if self.itemDrawn then

		g.interface:hideItemControls(self.itemDrawn)
		self.itemDrawn:holster()
		self.itemDrawn = nil
		g.stance:updateWalkSpeed()
		g.interaction:reset()
	end
end

function inventory:action(control)
	if g.stance:canDoAction() and (control ~= g.stats.controls.interact or not g.interaction.objectTargetting) then
		local toolSlot = g.stats.arbs.stringToToolSlot[control]
		if toolSlot then
			if self.tools[toolSlot] then
				self:drawOrHolsterItem(self.tools[toolSlot])
			end
		else
			for i, v in pairs(self.controllables or {}) do
				local action = v.stats.controls[control]
				if action and v[action] then
					v[action](v)
				end
			end
		end
	end
end

function inventory:getClosestStorage()
	local distance
	for i, v in pairs(g.operables) do
		if v.statusFolder:FindFirstChild("Items") and (g.rootPart.Position - v.model.PrimaryPart.Position).Magnitude < 6 then
			return v
		end
	end
end

return inventory
